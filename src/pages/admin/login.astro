---
// admin/login.astro - Session-based static login for local development
import Layout from '../../layouts/Layout.astro';
import { Astro } from 'astro/runtime';

const ADMIN_LOCAL_PASSWORD = import.meta.env.ADMIN_LOCAL_PASSWORD;
const ADMIN_SESSION_COOKIE = 'admin_session_id';
const ADMIN_SESSION_VALUE = 'authenticated';

let message = '';
let messageType: 'success' | 'error' = 'error';

if (Astro.request.method === 'POST') {
    try {
        const formData = await Astro.request.formData();
        const password = formData.get('password')?.toString() || '';

        if (password === ADMIN_LOCAL_PASSWORD) {
            // Set a simple session cookie
            Astro.cookies.set(ADMIN_SESSION_COOKIE, ADMIN_SESSION_VALUE, {
                httpOnly: true, // Important for security
                secure: Astro.url.protocol === 'https:', // Use secure cookie in production
                maxAge: 60 * 60 * 24 * 7, // 1 week
                path: '/admin', // Cookie only applies to /admin paths
            });
            return Astro.redirect('/admin/dashboard');
        } else {
            throw new Error('Incorrect password.');
        }

    } catch (error: any) {
        console.error("Login Error:", error.message);
        message = error.message;
        messageType = 'error';
    }
}
---

<Layout title="Admin Login">
    <section class="admin-auth-section">
        <div class="container admin-auth-container">
            <h1 class="heading-2 text-center mb-xl">Admin Login</h1>
            <p class="text-center text-neutral-600 mb-2xl">Enter your password to access the Divinex admin dashboard.</p>

            <form method="POST" class="admin-auth-form">
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" name="password" required class="form-input" placeholder="••••••••" autocomplete="current-password">
                </div>

                {message && (
                    <div class:list={['auth-message', messageType === 'error' ? 'auth-message-error' : 'auth-message-success']}>
                        {message}
                    </div>
                )}

                <button type="submit" class="btn-primary-full-width mt-xl">Login</button>
            </form>
        </div>
    </section>
</Layout>